{% extends "edt/base.html"%}
{% load staticfiles %}

{% block contenido %}
<link rel="stylesheet" type="text/css" href="{% static 'css/normalize.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/demo.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/component.css' %}" />

{% if usuario.rol.nivel_acceso == 0 %}
{% endif %}

<form method="post" id="el_form">{% csrf_token %}
<div class="filtros">
    <ul>
        <li>{{ form.funcionario.errors }}
            <label class="label label-info">Funcionario</label>
            {{ form.funcionario }}
        </li>
        <li>{{ form.tipo.errors }}
            <label class="label label-info">Tipo de Licencia</label>
            {{ form.tipo }}
        </li>
        <li>{{ form.reposo.errors }}
            <label class="label label-info">Características del Reposo</label>
            {{ form.reposo }}
        </li>
        <li>{{ form.especialidad.errors }}
            <label class="label label-info">Especialidad</label>
            {{ form.especialidad }}
        </li>
        <li>{{ form.medico.errors }}
            <label class="label label-info">Identificación del Profesional</label>
            {{ form.medico }}
        </li>
        <li>{{ form.cantidad_dias.errors }}
            <label class="label label-info">Días de Licencia</label>
            {{ form.cantidad_dias }}
        </li>
        <li>{{ form.inicio.errors }}
            <label class="label label-info">Duración</label>
            <input id="inicio" type="date" placeholder="Fecha de inicio" name="inicio"/>
            <input id="fin" type="date" placeholder="Fecha de término" name="fin" readonly />
        </li>
        <li class="botfiltro">
            <input class="btn btn-danger" type="submit" value="Guardar" id="guardar" name="Guardar" />
        </li>
    </ul>
</div>
</form>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const es_chrome = navigator.userAgent.toLowerCase().includes('chrome');
    const es_firefox = navigator.userAgent.toLowerCase().includes('firefox');
    if (es_chrome) {
        console.log("El navegador que se está utilizando es Chrome");
    }
    if (es_firefox) {
        console.log("El navegador que se está utilizando es Firefox");
    }

    let registrado = false;
    const mensaje = 'El funcionario ya registra una licencia en esa fecha';

    document.getElementById("guardar").addEventListener("click", function(e) {
        if (!validaFormulario()) {
            e.preventDefault();
        }
    });

    document.getElementById("id_funcionario").addEventListener("change", revisarDisponibilidad);
    document.getElementById("inicio").addEventListener("change", revisarDisponibilidad);
    document.getElementById("inicio").addEventListener("change", fechaTermino);

    function validaFormulario() {
        const $funcionario = document.getElementById("id_funcionario");
        const $tipo = document.getElementById("id_tipo");
        const $reposo = document.getElementById("id_reposo");
        const $especialidad = document.getElementById("id_especialidad");
        const $medico = document.getElementById("id_medico");
        const $diaslicencia = document.getElementById("id_cantidad_dias");
        const $fecha = document.getElementById("inicio");

        if (!$funcionario.value) {
            alert('ATENCIÓN!! : Debe seleccionar un funcionario');
            return false;
        }
        if (!$tipo.value) {
            alert('ATENCIÓN!! : Debe seleccionar un Tipo de licencia');
            return false;
        }
        if (!$reposo.value) {
            alert('ATENCIÓN!! : Debe seleccionar un Tipo de reposo');
            return false;
        }
        if (!$especialidad.value) {
            alert('ATENCIÓN!! : Debe seleccionar especialidad');
            return false;
        }
        if (!$medico.value) {
            alert('ATENCIÓN!! : Debe ingresar el nombre del medico tratante');
            return false;
        }
        if (!$diaslicencia.value || $diaslicencia.value < 1) {
            alert('ATENCIÓN!! : La cantidad de días de licencia debe ser mayor a 0');
            return false;
        }
        if (!$fecha.value) {
            alert("ATENCIÓN!! : Ingrese la fecha de inicio de licencia");
            return false;
        }
        return true;
    }

    function revisarDisponibilidad() {
        const id_funcionario = document.getElementById("id_funcionario").value;
        const inicio = document.getElementById("inicio").value;
        const fin = document.getElementById("fin").value;

        if (id_funcionario && inicio && fin) {
            consultarDisponibilidad(id_funcionario, inicio, fin);
        }
    }

    async function consultarDisponibilidad(funcionario, inicio, fin) {
        try {
            const response = await fetch(`/licencia/validar?funcionario=${funcionario}&inicio=${inicio}&fin=${fin}`);
            const data = await response.json();
            registrado = data.registrado;

            if (registrado) {
                alert(mensaje);
            }
        } catch (error) {
            console.error('Error en la consulta de disponibilidad:', error);
        }
    }

    function fechaTermino() {
        const iniciolic = document.getElementById("inicio").value;
        const diaslic = document.getElementById("id_cantidad_dias").value;

        if (iniciolic && diaslic) {
            sumaFecha(iniciolic, diaslic);
        }
    }

    function sumaFecha(iniciolic, diaslic) {
        const parts = iniciolic.split('-');
        const Fecha = new Date(parts[0], parts[1] - 1, parts[2]);

        diaslic = parseInt(diaslic) - 1; // Restar 1 para incluir el día de inicio
        Fecha.setDate(Fecha.getDate() + diaslic);

        const anno = Fecha.getFullYear();
        let mes = Fecha.getMonth() + 1;
        let dia = Fecha.getDate();

        mes = mes < 10 ? "0" + mes : mes;
        dia = dia < 10 ? "0" + dia : dia;
        
        const fechaFinal = `${anno}-${mes}-${dia}`;
        document.getElementById("fin").value = fechaFinal;
        console.log(fechaFinal);
        return fechaFinal;
    }
});
</script>
{% endblock %}
