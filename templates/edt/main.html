{% extends "edt/base.html" %}
{% load staticfiles %}
<!-- ... -->

{% block contenido %}

<a href="#" id="mostrarocultar" name="mostrarocultar" value="mostrarocultar" class="mostrarocultar btn btn-info btn-sm">Click para Mostrar/Ocultar Resumen</a>

<div id="listapermisos" class="listapermisos"> 
	{% if usuarios %}
  <table class=" table-bordered table-hover bgeneral TFtable" >
            <thead>
                <tr>
                  
                  <th class="nombre">Nombre</th>
                  <th>Estamento</th>
                  <th>Horas solicitadas</th>
                  <th>Horas Aprobadas</th>
                  <th>Horas Rechazadas</th>
                  <th>Horas a Recuperar Acumuladas</th>
                  <th>Horas Recuperadas</th>
                  <th>Saldo Horas por Recuperar</th>                  
                  <th>Horas por Descontar Acumuladas</th>
                  <th>Horas Descontadas</th>
                  <th>Saldo Horas por Descontar</th>
                  <th>Horas sin Recuperación con Goce de Sueldo</th>
                  <th>Horas pendientes de Revisión</th>
                  
                </tr>
              </thead>
            <tbody>   
  {% for usuario in usuarios %}

            <tr {% if  usuario.estado == '6' %} class='anulado' {% endif %} >
                <td>{{usuario.apellido1}} {{usuario.apellido2}} {{usuario.nombre}}</td>                
                <td>{{usuario.estamento}}</td>
                <td class="horas">{{usuario.total_horas}}</td>
                <td class="horas">{{usuario.aprobadas}}</td>
                <td class="horas">{{usuario.rechazadas}}</td>
                <td class="horas">{{usuario.devolveracumuladas}}</td>           
                <td class="horas">{{usuario.devueltas}}</td>
                <td class="horas">{{usuario.saldodevolucion}}</td>
                <td class="horas">{{usuario.descontaracumuladas}}</td>
                <td class="horas">{{usuario.descontadas}}</td>                
                <td class="horas">{{usuario.saldodescontar}}</td>
                <td class="horas">{{usuario.sin_recup_con_sueldo}}</td>
                <td class="horas">{{usuario.pendientes_por_aprobar}}</td>
                              
            </tr>       

            <!-- <tr>
                <td>{{resolucion.id }}</td>
                <td>{% if resolucion.ultimaResolucion %} {{ resolucion.ultimaResolucion.get_respuesta_display }}  {% endif %}</td>
                <td></td>
                <td></td>

            </tr> -->

  {% empty %}
      <tr>
        <td class="list-group-item">En este momento no hay ningun elemento para mostrar</td>
      </tr>
        {% endfor %}           
        </tbody>    
    </table>
 
  {# .... **Comienzo de la paginacion** .... #}
    {% if is_paginated %}
        <div class="pagination">
            <span class="page-links">
                {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}"><img width="25px" height="25px" src='/static/img/back.png' alt='Volver'/></a>
                {% endif %}
                <span class="page-current">
                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}.
                </span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}"><img width="25px" height="25px" src='/static/img/next.png' alt='Siguiente'/></a>
                {% endif %}
            </span>
        </div>
    {% endif %}

{% endif %}
<table class=" table-bordered table-hover bgeneral TFtable" >
            <thead>
                <tr>  
                  <th></th>
                  <th>Fecha</th>
                  <th>Tipo</th>
                  <th>Horas solicitadas</th>
                  <th>Horas Aprobadas</th>
                  <th>Horas Rechazadas</th>
                  <th>Horas a Recuperar Acumuladas</th>
                  <th>Horas Recuperadas</th>
                  <th>Saldo Horas por Recuperar</th>                  
                  <th>Horas por Descontar Acumuladas</th>
                  <th>Horas Descontadas</th>
                  <th>Saldo Horas por Descontar</th>
                  <th>Horas sin Recuperación con Goce de Sueldo</th>
                  <th>Horas pendientes de Revisión</th>                  
                </tr>
              </thead>
            <tbody>
{% for hora in horas %}
			<tr {% if  hora.permiso.estado.id == 6 %} class='anulado' {% endif %} >
                <td class="horas">
                	<a class="list-group-item" href="{% url 'edt.views.verpermiso2' hora.permiso.pk %}"> {{forloop.counter}}</a>
                </td>
     			<td class="horas">{{ hora.permiso.primerEvento.numero_evento.start |date:"d F Y" }}</td>	                
                <td class="horas">{{hora.permiso.tipo}}</td>
                <td class="horas negrita">{{hora.horas_solicitadas}}</td>
                <td class="horas">{{hora.horas_aprobadas}}</td>
                <td class="horas">{{hora.horas_rechazadas}}</td>
                <td class="horas">{{hora.horas_por_devolver_acumuladas}}</td>           
                <td class="horas">{{hora.horas_devueltas}}</td>
                <td class="horas negrita">{{hora.horas_por_devolver}}</td>
                <td class="horas">{{hora.horas_descontar_acumuladas}}</td>
                <td class="horas">{{hora.horas_descontadas}}</td>                
                <td class="horas negrita">{{hora.horas_descontar}}</td>
                <td class="horas">{{hora.horas_sin_recuperacion_con_goce}}</td>
                <td class="horas">{{hora.horas_pendientes_por_aprobar}}</td>
                              
            </tr>

{% endfor %}
</tbody>    
    </table>

</div>

<form id="main" name="main" class="form-horizontal" action="/urlcalendario/" method="post" enctype="multipart/form-data">
	<div  class="permiso" >
		<div id="frmpermiso">	
		{{form.tipo.errors}}
		<p><label for="tipo" >Tipo de Permiso<br/> a solicitar</label>{{form.tipo}}</p>
		</div>
		<div id="frmpermiso">
		{{form.devuelve_horas.errors}}
		<p class="devuelve_horas"><label for="fecha_devuelve_horas">Me comprometo a recuperar <br/> la(s) hora(s) </label>{{form.devuelve_horas}}</p>
		</div>
		<div id="frmpermiso">
		{{form.sueldo.errors}}
		<p class="sueldo"><label for="sueldo">Solicitud con o sin <br/>goce de sueldo</label>{{form.sueldo}}</p>
		</div>		
	</div>

	<div class="permiso">
		<div id="frmpermiso">
		{{form.motivo.errors}}
		<p><label for="motivo" >Motivo</label>{{form.motivo}}</p>
		</div>	
		<div id="frmpermiso">
		{{form.comentario.errors}}
		<p><label for="comentario">Comentario:</label>{{form.comentario}}</p>
		</div>	
		<div id="frmpermiso">
		<p class="reemplazante"><label for="reemplazante">Propuesta de Reemplazante</label>{{form.reemplazante}}</p>
		</div>	
		<div id="frmpermiso">
		<p class="documento_adjunto"><label for="documento_adjunto">Documento adjunto</label>{{form.documento_adjunto}}</p>	
		</div>		

	</div>
	<div class="alert alert-warning">IMPORTANTE : La anulación de un permiso solo se efectua a través de su jefatura directa, quien debera solicitarla a RRHH.</div>	
	<div id='calendar'></div>
		<input type="hidden" id="calendario-data" name="data-calendario">

	<input class="btn btn-success btn-lg" type="submit" value="Solicitar" id="botonCalendario"/>
	</form>
<script>
//por ahora aca, a futuro un poco mas ordenado
var seleccionados = [];
$(document).ready(function(){
	$( "input[type=file]" ).last().addClass( "custom-file-input" );
	$('#calendar').fullCalendar({
       // put your options and callbacks here   
       selectable:true,
       selectHelper:true,
       unselectAuto:false,
       // minTime:"00:00:00",
       // maxTime : '00:00:00',
       height: "auto",
       lang: 'es',
       timezone:'America/Santiago',
       defaultView: 'agendaWeek',
       schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
       header:
	       {
	       left:   'title',
	       center: '',
	       right:  'month agendaWeek agendaDay  prev,next'
	       },
       weekends: true,
       businessHours:true, 
       businessHours:
	       {
		   start: '08:00', // a start time (10am in this example)
	   	   end: '22:30', // an end time (6pm in this example)
	   	   dow: [ 1, 2, 3, 4 , 5, 6]	
	   	   },
	events: 'http://cal.cdegaulle.cl/wsCalendari/',	

	eventAfterRender: function(event,element){
		if(event.used){
			$(element).css('background','red');
			$(element).css('font-weight', 'bold');
			$(element).css('border-color','black');
			$(element).css('border','3');
			}	
	},
	 
   	   eventClick: function(event){
   	   		var hoy = new Date();
			var dd = hoy.getDate();
			var mm = hoy.getMonth()+1; //hoy es 0!
			var yyyy = hoy.getFullYear();
			var ms = hoy.getTime();
			if(dd<10) {dd='0'+dd} 
			if(mm<10) {mm='0'+mm} 
			hoy = mm+'/'+dd+'/'+yyyy;
			var dosdias = 172800; 
			var fecha_actual = new Date(ms);
			var fecha_actualMsec = fecha_actual.getMilliseconds();

			var fecha_evento = new Date(event.start);
			var fecha_eventoMsec = fecha_evento.getMilliseconds();
			var diferencia = ((fecha_evento - fecha_actual )/1000); // calculada en milisegundos
			
			// console.log(fecha_actual);
			// console.log (fecha_evento);
			// console.log("Diferencia" , diferencia);
			
	   	// Comprueba si el permiso se pide con 48 horas de anticipacion
	  // if(diferencia < dosdias && fecha_actual < fecha_evento ){
	  // 	alert("El permiso dede ser solicitado con la menos 48 horas de anticipacion")
	  	
	  // }else{		    
	  	//revisa si no esta en la lista
	   if(seleccionados.indexOf(event.id) == -1 && (event.used == false))  {
			seleccionados.push(event.id);
			$(this).css('background', '#00FF05');
			$(this).css('font-weight', 'bold');
			$(this).css('color', 'black');

		}else if (event.used == false){ // si ya esta lo quitamos y reseteamos el color
									
			seleccionados.splice(seleccionados.indexOf(event.id),1);
			$(this).css('background', '#3a87ad');
			$(this).css('color', '#ffffff');
			$(this).css('font-weight', 'bold');
			

			}
				//console.log(event.start);
				var ordenado = seleccionados.sort();//ordeno el arreglo para su correcto guadado
				console.log(seleccionados);
			// }	//fin comprobacion de 48 horas	
								}, // end fullcalendar       						 		
		
		})//end function 
})// end ready
</script>
<script type="text/javascript">
$(document).ready(function(){
	$("#mostrarocultar").click(function(){
        $("#listapermisos").toggle();
    });

	$("#main").submit(function(e){
		if(seleccionados.length == 0){
			alert("Debe seleccionar al menos un bloque de su horario");
			e.preventDefault();
		}

		
		$("#calendario-data").val(JSON.stringify(seleccionados));

		//
		//e.preventDefault();
	});
});
</script>   
{% endblock  %}