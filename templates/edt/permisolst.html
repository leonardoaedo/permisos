{% extends "edt/base.html" %}
{% load staticfiles %}

{% block contenido %}

{% if usuario.rol.nivel_acceso == 0 %}
  <div class="filtros">
    <form id="horas" class="form-horizontal" method="get">
      <fieldset>
        <ul>
          <li>
            <label class="label label-primary">Funcionario</label>
            <select name="persona">
              <option value="0">Seleccione Funcionario</option>
              {% for persona in usuarios_filtro %}
                <option value="{{ persona.id }}" {% if persona.usuario_activo %}selected{% endif %}>
                  {{ persona }}
                </option>
              {% endfor %}
            </select>
          </li>
          <li>
            <label class="label label-primary">Estamento</label>
            <select name="estamento">
              <option value="0">Seleccione Estamento</option>
              {% for estament in estamento_filtro %}
                <option value="{{ estament.id }}" {% if estament.estamento_activo %}selected{% endif %}>
                  {{ estament }}
                </option>
              {% endfor %}
            </select>
          </li>
          <li class="botfiltro">
            <input class="btn btn-success" type="submit" value="Filtrar" id="filtrar" name="filtrar" />
            <input class="btn btn-danger" type="submit" value="Quitar Filtros" id="limpiar" name="limpiar" />
          </li>
        </ul>
      </fieldset>
    </form>
  </div>
{% endif %}

<div class="pxp">
  <h4>Permisos pendientes de aprobación</h4>
  
  <ul class="list-group permisolst" id="permiso-list">
    {% for permiso in permisos_list %}
      <li>
        <a class="list-group-item" href="{% url 'edt.views.verpermiso' permiso.pk %}">
          <div class="numeropermiso">N° {{ permiso.id }}</div>
          <div class="nombrefuncionario">{{ permiso.usuario.nombre }} {{ permiso.usuario.apellido1 }}</div>
          <div class="fechapermiso">{{ permiso.primerEvento.numero_evento.start|date:"d F Y" }}</div>
          <div>{{ permiso.tipo }}</div>
          <span class="badge3">{{ permiso.usuario.jefatura.nombre }}</span>

          {% for bitacora in bitacoras %}
            {% if bitacora.permiso.id == permiso.id %}
              {% if bitacora.actividad.id == 2 %}
                {% if bitacora.usuario.cargo.id == 27 %}<span class="badge2">Dirección Secundaria</span>{% endif %}
                {% if bitacora.usuario.cargo.id == 7 %}<span class="badge2">Dirección General</span>{% endif %}
                {% if bitacora.usuario.cargo.id == 26 %}<span class="badge2">Dirección Primaria</span>{% endif %}
                {% if bitacora.usuario.cargo.id == 13 %}<span class="badge2">Gerencia</span>{% endif %}
                {% if bitacora.usuario.cargo.id == 10 %}<span class="badge2">Encargado Mantención</span>{% endif %}
                {% if bitacora.usuario.cargo.id == 15 %}<span class="badge2">CPE</span>{% endif %}
              {% endif %}
            {% endif %}
          {% endfor %}
        </a>
      </li>
    {% empty %}
      <li class="list-group-item">En este momento no hay ningún elemento para mostrar</li>
    {% endfor %}
  </ul>

  <!-- Loader -->
  <div id="loader" style="display: none; text-align: center; padding: 20px;">
    <img src="{% static 'images/loader.gif' %}" alt="Cargando..." />
  </div>
  
</div>

<script>
  let page = 2;
  let loading = false;

  function loadMorePermisos() {
    if (loading) return;
    loading = true;
    document.getElementById('loader').style.display = 'block';

    fetch(`?page=${page}`, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      }
    })
    .then(response => response.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newItems = doc.querySelectorAll('.list-group-item');
      const permisoList = document.getElementById('permiso-list');

      newItems.forEach(item => permisoList.appendChild(item));
      
      document.getElementById('loader').style.display = 'none';
      page += 1;
      loading = false;
    })
    .catch(error => {
      console.error('Error al cargar permisos:', error);
      document.getElementById('loader').style.display = 'none';
      loading = false;
    });
  }

  window.addEventListener('scroll', () => {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100 && !loading) {
      loadMorePermisos();
    }
  });
</script>

{% endblock %}
